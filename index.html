<!DOCTYPE html>
<html>
<head>
  <title>BNB Wallet Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; background: #000; color: #fff; text-align: center; padding-top: 20px; }
    .box { margin: 20px auto; padding: 20px; border: 1px solid #444; width: 90%; max-width: 600px; }
    .address { color: #ffd700; word-break: break-all; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #333; }
    input { width: 90%; padding: 10px; margin: 10px 0; background: #222; color: white; border: 1px solid #444; }
    button { padding: 10px 20px; margin: 5px; background: #f0b90b; color: black; border: none; cursor: pointer; }
    button:disabled { background: #666; cursor: not-allowed; }
    .warning { color: #ff6b6b; font-weight: bold; }
  </style>
</head>
<body>

  <h1>BNB Wallet Generator</h1>

  <div class="box">
    <!-- إنشاء محفظة -->
    <div class="section">
      <h3>إنشاء محفظة جديدة</h3>
      <button id="btnCreate">إنشاء محفظة جديدة</button>
      <div id="walletInfo"></div>
    </div>

    <!-- استيراد محفظة -->
    <div class="section">
      <h3>استيراد محفظة موجودة</h3>
      <input type="text" id="privateKeyInput" placeholder="Private Key (0x...)">
      <button id="btnImport">استيراد المحفظة</button>
    </div>

    <!-- إرسال BNB -->
    <div class="section">
      <h3>إرسال BNB</h3>
      <input type="text" id="toAddress" placeholder="عنوان المستلم (0x...)">
      <input type="number" id="sendAmount" placeholder="المبلغ (BNB)" step="0.0001" min="0">
      <button id="btnSend" disabled>إرسال BNB</button>
      <div id="sendStatus"></div>
    </div>

    <!-- معلومات المحفظة -->
    <div class="section">
      <h3>معلومات المحفظة الحالية</h3>
      <div id="currentWallet">لم يتم تحميل محفظة بعد</div>
      <div id="balanceInfo"></div>
    </div>
  </div>

  <script>
    let currentAccount = null;
    let web3BSC = null;
    let web3 = null;

    // تهيئة Web3
    function initWeb3() {
      if (typeof Web3 === "undefined") {
        alert("Error: web3 library not loaded.");
        return false;
      }
      web3 = new Web3();
      web3BSC = new Web3("https://bsc-dataseed.binance.org/");
      return true;
    }

    // تحديث واجهة المحفظة
    function updateWalletUI() {
      if (!currentAccount) {
        document.getElementById("currentWallet").innerHTML = "لم يتم تحميل محفظة بعد";
        document.getElementById("btnSend").disabled = true;
        return;
      }

      document.getElementById("currentWallet").innerHTML = `
        <p><b>Address:</b> <span class="address">${currentAccount.address}</span></p>
        <p><b>Private Key:</b> <span class="address">${currentAccount.privateKey}</span></p>
        <p class="warning">⚠️ لا تشارك المفتاح الخاص مع أي شخص ⚠️</p>
      `;
      
      document.getElementById("btnSend").disabled = false;
      updateBalance();
    }

    // تحديث الرصيد
    async function updateBalance() {
      if (!currentAccount || !web3BSC) return;
      
      try {
        const balanceWei = await web3BSC.eth.getBalance(currentAccount.address);
        const balanceBNB = web3BSC.utils.fromWei(balanceWei, "ether");
        document.getElementById("balanceInfo").innerHTML = `
          <p><b>الرصيد:</b> ${balanceBNB} BNB</p>
          <p><b>الرصيد بالوي:</b> ${balanceWei} wei</p>
        `;
      } catch (error) {
        document.getElementById("balanceInfo").innerHTML = `<p class="warning">خطأ في جلب الرصيد: ${error.message}</p>`;
      }
    }

    // إنشاء محفظة جديدة
    document.getElementById("btnCreate").addEventListener("click", async () => {
      if (!initWeb3()) return;
      
      currentAccount = web3.eth.accounts.create();
      document.getElementById("walletInfo").innerHTML = `
        <p>تم إنشاء محفظة جديدة بنجاح!</p>
      `;
      updateWalletUI();
    });

    // استيراد محفظة
    document.getElementById("btnImport").addEventListener("click", async () => {
      const privateKey = document.getElementById("privateKeyInput").value.trim();
      
      if (!privateKey || !privateKey.startsWith('0x')) {
        alert("يرجى إدخال مفتاح خاص صحيح يبدأ بـ 0x");
        return;
      }

      if (!initWeb3()) return;
      
      try {
        currentAccount = web3.eth.accounts.privateKeyToAccount(privateKey);
        document.getElementById("privateKeyInput").value = "";
        document.getElementById("walletInfo").innerHTML = `<p>تم استيراد المحفظة بنجاح!</p>`;
        updateWalletUI();
      } catch (error) {
        alert(`خطأ في استيراد المحفظة: ${error.message}`);
      }
    });

    // إرسال BNB
    document.getElementById("btnSend").addEventListener("click", async () => {
      if (!currentAccount || !web3BSC) {
        alert("يرجى تحميل محفظة أولاً");
        return;
      }

      const toAddress = document.getElementById("toAddress").value.trim();
      const amountBNB = document.getElementById("sendAmount").value.trim();

      if (!toAddress || !web3BSC.utils.isAddress(toAddress)) {
        alert("يرجى إدخال عنوان مستلم صحيح");
        return;
      }

      if (!amountBNB || parseFloat(amountBNB) <= 0) {
        alert("يرجى إدخال مبلغ صحيح أكبر من الصفر");
        return;
      }

      try {
        document.getElementById("sendStatus").innerHTML = "<p>جاري معالجة التحويل...</p>";
        
        // تحويل المبلغ من BNB إلى wei
        const amountWei = web3BSC.utils.toWei(amountBNB, 'ether');
        
        // الحصول على سعر الغاز
        const gasPrice = await web3BSC.eth.getGasPrice();
        
        // تقدير الغاز المطلوب
        const gasEstimate = await web3BSC.eth.estimateGas({
          from: currentAccount.address,
          to: toAddress,
          value: amountWei
        });

        // التحقق من الرصيد الكافي (القيمة + رسوم الغاز)
        const balanceWei = await web3BSC.eth.getBalance(currentAccount.address);
        const totalCost = BigInt(amountWei) + BigInt(gasEstimate) * BigInt(gasPrice);
        
        if (BigInt(balanceWei) < totalCost) {
          const neededBNB = web3BSC.utils.fromWei((totalCost - BigInt(balanceWei)).toString(), 'ether');
          throw new Error(`رصيد غير كافي. تحتاج إلى ${neededBNB} BNB إضافية لتغطية رسوم الغاز`);
        }

        // إنشاء المعاملة
        const tx = {
          from: currentAccount.address,
          to: toAddress,
          value: amountWei,
          gas: gasEstimate,
          gasPrice: gasPrice,
          chainId: 56 // شبكة BSC Mainnet
        };

        // توقيع المعاملة
        const signedTx = await web3BSC.eth.accounts.signTransaction(tx, currentAccount.privateKey);
        
        // إرسال المعاملة
        const receipt = await web3BSC.eth.sendSignedTransaction(signedTx.rawTransaction);
        
        document.getElementById("sendStatus").innerHTML = `
          <p style="color: green;">تم إرسال التحويل بنجاح!</p>
          <p><b>معرف المعاملة:</b> <span class="address">${receipt.transactionHash}</span></p>
          <p><b>رسوم الغاز المستخدمة:</b> ${web3BSC.utils.fromWei((BigInt(receipt.gasUsed) * BigInt(gasPrice)).toString(), 'ether')} BNB</p>
        `;
        
        // تحديث الرصيد
        updateBalance();
        
        // مسح الحقول
        document.getElementById("toAddress").value = "";
        document.getElementById("sendAmount").value = "";
        
      } catch (error) {
        document.getElementById("sendStatus").innerHTML = `
          <p class="warning">خطأ في الإرسال: ${error.message}</p>
        `;
        console.error("Send error:", error);
      }
    });

    // التهيئة الأولية
    window.onload = function() {
      initWeb3();
    };
  </script>
</body>
</html>
